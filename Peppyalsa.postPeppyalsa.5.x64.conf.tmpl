#------ PeppyMeter section (x64) -------
#
# x64 version: Meter NOT inline with main audio path.
# Reason: volumioswitch uses mmap which meter plugin cannot handle.
# Solution: Main audio bypasses meter, separate MPD output provides meter data.
#

# ---> pass through audio pipeline
# if separate alsa pipeline enabled (DSD direct)
pcm.${alsaDirect} {
  type empty
  slave.pcm "postpeppyalsa"
}

# ---> input from modular alsa
# x64: Empty passthrough - meter data comes from separate MPD output
pcm.${alsaMeter} {
  type empty
  slave.pcm "postpeppyalsa"
}

# ---> input from exclusive MPD output for peppyalsa
# This receives audio from mpd_custom.conf output
pcm.mpd_peppyalsa {
  type meter
  slave.pcm "dummy"
  scopes.0 peppyalsa
}

# ---> separate airplay input
# x64: Empty passthrough to avoid mmap issues
pcm.airplay {
  type empty
  slave.pcm "postpeppyalsa"
}

# ---> separate spotify input
pcm.${spotDirect} {
  type empty
  slave.pcm "postpeppyalsa"
}

pcm.${spotMeter} {
  type plug
  slave {
    pcm "spd_peppyalsa"
    format "S16_LE"
  }
}

# spotify meter definition
pcm.spd_peppyalsa {
  type meter
  slave.pcm "copy_output"
  scopes.0 peppyalsa
}

# standard scope - adjusted meter_max for better sensitivity on x64
pcm_scope.peppyalsa {
  type peppyalsa
  decay_ms 500
  meter "/tmp/myfifo"
  meter_max 100
  meter_show 0
  spectrum "/tmp/myfifosa"
  spectrum_max 100
  spectrum_size 20
  logarithmic_frequency 1
  logarithmic_amplitude 1
  smoothing_factor 40
}

pcm_scope_type.peppyalsa {
  lib /data/plugins/user_interface/peppy_screensaver/lib/libpeppyalsa.so
}

# null output - use ALSA null instead of hw:Dummy for x64 compatibility
pcm.dummy {
  type hw
  card Dummy
}

# needed for some sound cards otherwise Spotify stops playing after 10 seconds
pcm.copy_output {
  type ${type}
  slave.pcm "postpeppyalsa"
}

pcm.postpeppyalsa {
  type empty
  slave.pcm "postPeppyalsa"
}
#------ End of PeppyMeter section ------
